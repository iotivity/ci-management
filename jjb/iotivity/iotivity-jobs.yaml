- project:
    name: iotivity-jobs
    project: 'iotivity'
    branch: '**'
    jobs:
        - 'iotivity-merge'
        - 'iotivity-merge-1.1-rel'
        - 'iotivity-verify-{component}'
        - 'iotivity-verify-osx'
        - 'iotivity-sonar-runner'
    component:
        - 'linux_unsecured'
        - 'linux_secured'
        - 'arduino'
        - 'simulator'

- project:
    name: iotivity-unit-tests
    project: 'iotivity'
    jobs:
        - 'iotivity-verify-unit_tests'

- project:
    name: iotivity-verify-tizen
    project: 'iotivity'
    jobs:
        - 'iotivity-verify-tizen'

- project:
    name: iotivity-android
    project: 'iotivity'
    arch:
        - 'armeabi'
    jobs:
        - 'iotivity-verify-android_{arch}'

- project:
    name: iotivity-upnp-bridge
    project: 'iotivity-upnp-bridge'
    jobs:
        - 'iotivity-verify-upnp-bridge'

- project:
    name: iotivity-windows
    project: 'iotivity'
    vs-version:
        - 'vs2013':
            silent: false
        - 'vs2015':
            silent: false
    jobs:
        - 'iotivity-verify-windows-{vs-version}'

- project:
    name: iotivity-java
    project: 'iotivity'
    branch: 'generic-java'
    component:
        - 'linux_unsecured_with_java'
        - 'linux_secured_with_java'
    jobs:
        - 'iotivity-verify-{component}'

- project:
    name: linux-unsecured-with-tcp
    project: 'iotivity'
    branch: '^(?!.*1.1-rel).*$'
    component:
        - 'linux_unsecured_with_tcp'
    jobs:
        - 'iotivity-verify-{component}'

- job-template:
    name: 'iotivity-verify-{component}'

    project-type: freestyle
    node: 'ubuntu1204'
    concurrent: true
    disabled: false

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch
        - gerrit-refspec

    scm:
        - gerrit-branch-scm:
            credentials-id: '{ssh-credentials}'

    triggers:
        - gerrit-trigger-patch-submitted:
            project: '{project}'
            branch: '{branch}'

    wrappers:
        - timestamps

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-bootstrap.sh
        - shell: |
            #!/bin/bash -eux
            set -o pipefail

            export VERBOSE=false
            export CCACHE_DISABLE=false

            ./auto_build.sh {component}

    publishers:
        - email-notification:
            mailto: 'oicbuild@intel.com'

- job-template:
    name: 'iotivity-verify-tizen'

    project-type: freestyle
    node: 'ubuntu1204'
    concurrent: true
    disabled: false

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch
        - gerrit-refspec

    scm:
        - gerrit-branch-scm:
            credentials-id: '{ssh-credentials}'

    triggers:
        - gerrit-trigger-patch-submitted:
            project: '{project}'
            branch: '{branch}'

    wrappers:
        - timestamps

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-bootstrap.sh
        - shell:
            !include-raw-escape: include-raw-iotivity-tizen.sh
        - shell: |
            #!/bin/bash -eux
            set -o pipefail

            export VERBOSE=false
            export CCACHE_DISABLE=false

            ./auto_build.sh tizen

    publishers:
        - email-notification:
            mailto: 'oicbuild@intel.com'

- job-template:
    name: 'iotivity-verify-unit_tests'

    project-type: freestyle
    node: 'ubuntu1204'
    concurrent: true
    disabled: false

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch
        - gerrit-refspec

    scm:
        - gerrit-branch-scm:
            credentials-id: '{ssh-credentials}'

    triggers:
        - gerrit-trigger-patch-submitted:
            project: '{project}'
            branch: '**'

    wrappers:
        - timestamps
        - build-timeout

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-bootstrap.sh
        - shell: |
            #!/bin/bash -eux
            set -o pipefail

            export VERBOSE=true
            export CCACHE_DISABLE=true

            ./auto_build.sh unit_tests

    publishers:
        - valgrind-report
        - xunit-report
        - archive-artifacts:
            artifacts: '*.memcheck, out/**/test_out/*.xml'
        - email-notification:
            mailto: 'oicbuild@intel.com'

- job-template:
    name: 'iotivity-verify-android_{arch}'

    project-type: freestyle
    node: 'ubuntu1204'
    concurrent: true
    disabled: false

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch
        - gerrit-refspec

    scm:
        - gerrit-branch-scm:
            credentials-id: '{ssh-credentials}'

    triggers:
        - gerrit-trigger-patch-submitted:
            project: '{project}'
            branch: '**'

    wrappers:
        - timestamps

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-bootstrap.sh
        - shell: |
            #!/bin/bash -eux
            set -o pipefail

            export VERBOSE=false
            export CCACHE_DISABLE=false

            ./auto_build.sh android_{arch}

    publishers:
        - archive-artifacts:
            artifacts: 'android/android_api/base/build/outputs/**/*.xml, android/android_api/base/build/outputs/**/*.html'
        - email-notification:
            mailto: 'oicbuild@intel.com'

- job-template:
    name: 'iotivity-verify-upnp-bridge'

    project-type: freestyle
    node: 'ubuntu1204'
    concurrent: true
    disabled: false

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch
        - gerrit-refspec

    scm:
        - git:
            credentials-id: '{ssh-credentials}'
            url: 'ssh://iotivity-jobbuilder@gerrit.iotivity.org:29418/iotivity'
            refspec: 'refs/heads/master'
            branches:
                - 'origin/master'
            skip-tag: true
            wipe-workspace: true
            choosing-strategy: 'default'
        - gerrit-iotivity-upnp-scm:
            credentials-id: '{ssh-credentials}'

    triggers:
        - gerrit-trigger-patch-submitted:
            project: '{project}'
            branch: '**'

    wrappers:
        - timestamps

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-bootstrap.sh
        - shell: |
            #!/bin/bash -eux
            set -o pipefail

            export VERBOSE=false
            export CCACHE_DISABLE=false

            cp -rv ${{WORKSPACE}}/iotivity-upnp-bridge/android/examples/upnpclient/ ${{WORKSPACE}}/android/examples
            sed -i "1 s/$/, ':upnpclient'/" ${{WORKSPACE}}/android/examples/settings.gradle

            ./auto_build.sh android_x86

    publishers:
        - archive-artifacts:
            artifacts: 'android/android_api/base/build/outputs/**/*.xml, android/android_api/base/build/outputs/**/*.html'
        - email-notification:
            mailto: 'oicbuild@intel.com'

- job-template:
    name: 'iotivity-verify-windows-{vs-version}'

    project-type: freestyle
    node: '{vs-version}'
    concurrent: true
    disabled: false

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch
        - gerrit-refspec

    scm:
        - git:
            credentials-id: '6466b968-939a-4d87-9f7f-0ceb5fca54dc'
            url: 'ssh://jenkins-iotivity@gerrit.iotivity.org:29418/iotivity'
            refspec: '$GERRIT_REFSPEC'
            branches:
                - 'origin/$GERRIT_BRANCH'
            skip-tag: true
            wipe-workspace: true
            choosing-strategy: 'gerrit'

    triggers:
        - gerrit:
            server-name: 'iotivity'
            silent: '{obj:silent}'
            trigger-on:
                - patchset-created-event:
                    exclude-drafts: 'false'
                    exclude-trivial-rebase: 'false'
                    exclude-no-code-change: 'true'
                - draft-published-event
                - comment-added-contains-event:
                    comment-contains-value: 'verify all'
                - comment-added-contains-event:
                    comment-contains-value: 'reverify'
            projects:
                - project-compare-type: 'ANT'
                  project-pattern: '{project}'
                  branches:
                    - branch-compare-type: 'REG_EXP'
                      branch-pattern: '^(?!.*1.1-rel).*$'

    wrappers:
        - timestamps

    builders:
        - batch:
            !include-raw-escape: include-raw-iotivity-windows-bootstrap.bat
        - batch: |
            @echo off
            run.bat build
            run.bat test
            run.bat clean

    publishers:
        - email-notification:
            mailto: 'oicbuild@intel.com'

- job-template:
    name: 'iotivity-verify-osx'

    project-type: freestyle
    node: 'osx1010'
    concurrent: true
    disabled: false

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch
        - gerrit-refspec

    scm:
        - gerrit-branch-scm:
            credentials-id: '{ssh-credentials}'

    triggers:
        - gerrit-trigger-patch-submitted:
            project: '{project}'
            branch: '**'

    wrappers:
        - timestamps

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-osx-bootstrap.sh
        - shell: |
            #!/bin/bash -eux
            set -o pipefail

            PATH=$PATH:/usr/local/bin/
            if (git rev-list HEAD | grep -q d0b861c0276208b3fd1b29bf98908e401c7ca17f); then
              ./auto_build.sh darwin
            fi
            # Run Tests against OSX 10.10 without Logging
            echo "*********** Build for OSX 10.10 *************"
            scons TARGET_OS=darwin SYS_VERSION=10.10 RELEASE=false
            scons TARGET_OS=darwin SYS_VERSION=10.10 RELEASE=false -c
            scons TARGET_OS=darwin SYS_VERSION=10.10 RELEASE=false LOGGING=false
            export DYLD_LIBRARY_PATH=./extlibs/gtest/gtest-1.7.0/lib/.libs
            ./out/darwin/x86_64/debug/resource/csdk/stack/test/stacktests

    publishers:
        - valgrind-report
        - xunit-report
        - archive-artifacts:
            artifacts: '*.memcheck'
        - email-notification:
            mailto: 'oicbuild@intel.com'

- job-template:
    name: 'iotivity-merge'

    project-type: freestyle
    node: 'integration'
    concurrent: true
    disabled: false

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch:
            branch: 'master'
        - gerrit-refspec:
            refspec: ''

    scm:
        - gerrit-merge-branch-scm:
            credentials-id: '{ssh-credentials}'
            refspec: 'refs/heads/master'

    triggers:
        - gerrit-trigger-silent-ref-updated:
            project: '{project}'
            branch: 'master'

    wrappers:
        - timestamps
        - ssh-agent-credentials:
            users:
                - '{ssh-credentials}'

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-bootstrap.sh
        - shell: |
            #!/bin/bash -eux
            set -o pipefail

            export VERBOSE=false
            export CCACHE_DISABLE=false

            ./auto_build.sh all

    publishers:
        - email-notification-unstable:
            mailto: 'oicbuild@intel.com, joseph.l.morrow@intel.com, tbramwell@linuxfoundation.org'

- job-template:
    name: 'iotivity-merge-1.1-rel'

    project-type: freestyle
    node: 'integration'
    concurrent: true
    disabled: false

    parameters:
        - gerrit-project:
            project: '{project}'
        - string:
            name: GERRIT_BRANCH
            default: '1.1-rel'
            description: "JJB configured GERRIT_BRANCH parameter"
        - string:
            name: GERRIT_REFSPEC
            default: 'refs/heads/1.1-rel'
            description: "GERRIT_REFSPEC parameter if not given by trigger"

    scm:
        - gerrit-merge-branch-scm:
            credentials-id: '{ssh-credentials}'

    triggers:
        - timed: 'H H * * *'

    wrappers:
        - timestamps
        - ssh-agent-credentials:
            users:
                - '{ssh-credentials}'

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-bootstrap.sh
        - shell: |
            #!/bin/bash -eux
            set -o pipefail

            export VERBOSE=false
            export CCACHE_DISABLE=false

            ./auto_build.sh all

    publishers:
        - email-notification-unstable:
            mailto: 'oicbuild@intel.com, joseph.l.morrow@intel.com, tbramwell@linuxfoundation.org'

- job-template:
    name: 'iotivity-sonar-runner'

    project-type: freestyle
    node: 'sonar'
    concurrent: true
    disabled: false

    parameters:
        - gerrit-project:
            project: '{project}'
        - gerrit-branch:
            branch: 'master'
        - gerrit-refspec:
            refspec: ''

    scm:
        - gerrit-branch-scm:
            credentials-id: '{ssh-credentials}'
            refspec: 'refs/heads/master'

    triggers:
        - gerrit-trigger-silent-ref-updated:
            project: '{project}'
            branch: 'master'

    wrappers:
        - timestamps
        - ssh-agent-credentials:
            users:
                - '{ssh-credentials}'

    builders:
        - shell:
            !include-raw-escape: include-raw-iotivity-sonar.sh
        - sonar:
            sonar-name: Sonar
            properties: |
                sonar.projectKey=iotivity:master
                sonar.projectName=Iotivity
                sonar.projectVersion=1.1.0

                sonar.sources=resource,service,examples,android,build_common,tools
                sonar.language=c++

                sonar.cxx.compiler.parser=GCC
                sonar.cxx.errorRecoveryEnabled=True

                sonar.cxx.includeDirectories=resource,service,examples,android,build_common,tools

                sonar.cxx.valgrind.reportPath=*.memcheck
                sonar.cxx.vera.reportPath=vera-report.xml
                sonar.cxx.cppcheck.reportPath=cppcheck-report.xml
                sonar.cxx.rats.reportPath=rats-report.xml

    publishers:
        - archive-artifacts:
            artifacts: '*-report.xml'
